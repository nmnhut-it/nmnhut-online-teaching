<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grade 9 - Unit 7: Natural Wonders | English Grammar Games</title>
  <meta name="description" content="Practice Reported Questions (Yes/No)">
  <link rel="stylesheet" href="../css/shared.css">
</head>
<body>
  <header class="game-header">
    <div class="container">
      <div class="game-header__container">
        <div class="game-header__info-section">
          <h1 class="game-header__title">Grade 9 - Unit 7: Natural Wonders of the World</h1>
          <p class="game-header__subtitle">Reported Questions (Yes/No)</p>
          <div class="game-info">
            <div class="game-info__item">
              <span class="game-info__label">Gi·o viÍn:</span>
              <span class="game-info__value">Nguy≈n Minh NhÒt</span>
            </div>
            <div class="game-info__item">
              <span class="game-info__label">HÕc sinh:</span>
              <span class="game-info__value">Trßn Gia H∞ng</span>
            </div>
          </div>
        </div>
        <div class="game-header__stats">
          <div class="stat">
            <span class="stat__label">i√m</span>
            <span class="stat__value stat__value--primary" id="current-score">‚≠ê 0</span>
          </div>
          <div class="stat">
            <span class="stat__label">Tiøn Ÿ</span>
            <span class="stat__value" id="progress-count">0 / 0</span>
          </div>
          <div class="stat" id="combo-display" style="display: none;">
            <span class="stat__label">Combo</span>
            <span class="stat__value" id="combo-count">0</span>
          </div>
        </div>
      </div>
      <div class="progress">
        <div class="progress__bar" id="progress-bar" style="width: 0%;"></div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="theory-panel" id="theory-panel">
      <button class="theory-panel__toggle" id="theory-toggle">
        <span>=÷ T‡i li«u ngÔ ph·p</span>
        <span class="theory-panel__icon" id="theory-icon">º</span>
      </button>
      <div class="theory-panel__content" id="theory-content">
        <div class="theory-panel__section">
          <h3 class="theory-panel__heading">Reported Questions (Yes/No)</h3>
          <p><strong>C•u tr˙c:</strong> S + asked + (O) + if/whether + S + V (l˘i thÏ)</p>
          <p><strong>L∞u ˝:</strong> KhÙng £o ngÔ trong m«nh ¡ sau if/whether. D•u ch•m hœi (?) chuy√n th‡nh d•u ch•m (.)</p>
          <div class="theory-panel__example">
            <strong>VÌ dÂ:</strong><br>
            " Direct: "Do you like natural wonders?"<br>
            " Reported: He asked me <strong>if I liked</strong> natural wonders.<br><br>
            " Direct: "Can you climb the mountain?"<br>
            " Reported: He asked me <strong>if I could climb</strong> the mountain.<br><br>
            " Direct: "Have you visited Ha Long Bay?"<br>
            " Reported: She asked me <strong>whether I had visited</strong> Ha Long Bay.
          </div>
        </div>
      </div>
    </div>
    <div id="exercise-container">
      <div class="card text-center">
        <h2>Loading...</h2>
        <p>Please wait while we load the exercises.</p>
      </div>
    </div>
  </main>

  <script src="../js/core/utils.js"></script>
  <script src="../js/core/storage.js"></script>
  <script src="../js/core/telegram-sender.js"></script>
  <script src="../js/core/student-name-manager.js"></script>
  <script src="../js/core/game-engine.js"></script>
  <script src="../js/exercises/multiple-choice.js"></script>
  <script src="../js/exercises/word-rearrange.js"></script>

  <script>
    const UNIT_ID = 'g9-unit-7-natural-wonders';
    const DATA_PATH = '../data/g9-unit-7-natural-wonders.json';

    const theoryToggle = document.getElementById('theory-toggle');
    const theoryContent = document.getElementById('theory-content');
    const theoryIcon = document.getElementById('theory-icon');

    theoryToggle.addEventListener('click', () => {
      const isExpanded = theoryContent.classList.contains('theory-panel__content--expanded');
      if (isExpanded) {
        theoryContent.classList.remove('theory-panel__content--expanded');
        theoryIcon.classList.remove('theory-panel__icon--rotated');
      } else {
        theoryContent.classList.add('theory-panel__content--expanded');
        theoryIcon.classList.add('theory-panel__icon--rotated');
      }
    });

    function updateComboDisplay() {
      const comboDisplay = document.getElementById('combo-display');
      const comboCount = document.getElementById('combo-count');
      const state = GameEngine.getState();
      if (state.comboCount >= 3) {
        comboDisplay.style.display = 'flex';
        comboCount.textContent = state.comboCount + 'x üî•';
      } else {
        comboDisplay.style.display = 'none';
      }
    }

    const originalUpdateUI = GameEngine.updateUI.bind(GameEngine);
    GameEngine.updateUI = function() {
      originalUpdateUI();
      updateComboDisplay();
    };

    async function loadAndStartGame() {
      // Initialize student name
      StudentNameManager.init();
      try {
        const response = await fetch(DATA_PATH);
        if (!response.ok) throw new Error(`Failed to load data: ${response.status}`);
        const unitData = await response.json();
        GameEngine.init(unitData, UNIT_ID);
      } catch (error) {
        console.error('Error loading game data:', error);
        const container = document.getElementById('exercise-container');
        container.innerHTML = `
          <div class="card">
            <h2 style="color: var(--danger);">Error Loading Game</h2>
            <p>Sorry, we couldn't load the exercise data. Please try refreshing the page.</p>
            <p style="font-size: var(--font-size-sm); color: var(--text-light);">Error: ${error.message}</p>
            <button class="btn btn--primary mt-2" onclick="location.reload()">Reload Page</button>
          </div>
        `;
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAndStartGame);
    } else {
      loadAndStartGame();
    }
  </script>
</body>
</html>
